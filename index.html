<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿå…‰åœ£è¯æ¸¸å›­ä¼š</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cedarville+Cursive&family=Inter:wght@300;400;500;600&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a1525;
            color: #f0e6d2;
            overflow: hidden;
            height: 100vh;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.8s ease, transform 0.8s ease;
            overflow: hidden;
        }

        /* ========== åŠ è½½ç•Œé¢ ========== */
        #loading-screen {
            background: linear-gradient(180deg, #0a1525 0%, #1a2b45 100%);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .snow-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .snowflake {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            animation: fall linear infinite;
        }

        @keyframes fall {
            to { transform: translateY(100vh); }
        }

        .gate-container {
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .gate {
            position: relative;
            width: 400px;
            height: 500px;
            margin: 0 auto;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .gate:hover {
            transform: scale(1.02);
        }

        .gate-frame {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3d2c1a 0%, #2a1c10 100%);
            border-radius: 20px;
            box-shadow: 
                inset 0 0 30px rgba(139, 69, 19, 0.7),
                0 0 60px rgba(255, 215, 0, 0.4),
                0 10px 40px rgba(0, 0, 0, 0.7);
            border: 8px solid #5d4037;
        }

        .gate-door {
            position: absolute;
            width: 46%;
            height: 85%;
            top: 7%;
            background: linear-gradient(135deg, #5d4037 0%, #3e2723 100%);
            border-radius: 10px;
            transition: transform 1.5s ease;
            box-shadow: 
                inset 0 0 20px rgba(0, 0, 0, 0.8),
                0 5px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .left-door {
            left: 4%;
            transform-origin: left center;
            border-right: 2px solid #8d6e63;
        }

        .right-door {
            right: 4%;
            transform-origin: right center;
            border-left: 2px solid #8d6e63;
        }

        .door-knocker {
            position: absolute;
            width: 50px;
            height: 70px;
            background: radial-gradient(circle at 30% 30%, #d4af37 0%, #b8860b 100%);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.5),
                inset 0 2px 5px rgba(255, 255, 255, 0.3);
            cursor: pointer;
            animation: pulse 2s infinite;
            z-index: 10;
        }

        .door-knocker:hover {
            animation: shake 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
        }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
        }

        .door-knocker-inner {
            width: 20px;
            height: 30px;
            background: #8b4513;
            border-radius: 50%;
        }

        .gate-decoration {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .holly {
            position: absolute;
            width: 100px;
            height: 80px;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background: #2e7d32;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }

        .holly::after {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            background: #d32f2f;
            border-radius: 50%;
            top: 20%;
            left: 30%;
            box-shadow: 
                25px 10px 0 #d32f2f,
                50px 0 0 #d32f2f;
        }

        .lights {
            position: absolute;
            width: 100%;
            height: 20px;
            top: 15%;
            display: flex;
            justify-content: space-around;
        }

        .light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: gold;
            animation: twinkle 1.5s infinite;
            box-shadow: 0 0 10px gold;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }

        .gate-text {
            margin-top: 30px;
            font-family: 'Cedarville Cursive', cursive;
            font-size: 24px;
            color: #f0e6d2;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            letter-spacing: 2px;
            animation: textGlow 3s infinite;
        }

        @keyframes textGlow {
            0%, 100% { text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            50% { text-shadow: 0 0 15px rgba(255, 215, 0, 0.9), 0 0 20px rgba(255, 215, 0, 0.5); }
        }

        .loading-progress {
            position: absolute;
            bottom: 20%;
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #ffd700);
            width: 0%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* ========== åœ°å›¾ç•Œé¢ ========== */
        #map-screen {
            background: radial-gradient(ellipse at center, #1a237e 0%, #0d0f2e 70%, #000 100%);
            opacity: 0;
            pointer-events: none;
            z-index: 90;
        }

        .map-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            perspective: 1000px;
        }

        .map-background {
            position: absolute;
            width: 120%;
            height: 120%;
            top: -10%;
            left: -10%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(198, 119, 119, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(119, 198, 163, 0.3) 0%, transparent 50%);
            animation: aurora 20s infinite alternate;
        }

        @keyframes aurora {
            0% { filter: hue-rotate(0deg); transform: rotate(0deg); }
            100% { filter: hue-rotate(20deg); transform: rotate(0.5deg); }
        }

        .map-content {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 1s ease;
        }

        .christmas-tree {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 200px;
            z-index: 5;
            cursor: pointer;
        }

        .tree-trunk {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 40px;
            background: #8b4513;
            border-radius: 5px;
        }

        .tree-body {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 60px solid transparent;
            border-right: 60px solid transparent;
            border-bottom: 100px solid #2e7d32;
        }

        .tree-body::before {
            content: '';
            position: absolute;
            top: 30px;
            left: -50px;
            width: 0;
            height: 0;
            border-left: 50px solid transparent;
            border-right: 50px solid transparent;
            border-bottom: 80px solid #388e3c;
        }

        .tree-body::after {
            content: '';
            position: absolute;
            top: 60px;
            left: -40px;
            width: 0;
            height: 0;
            border-left: 40px solid transparent;
            border-right: 40px solid transparent;
            border-bottom: 60px solid #43a047;
        }

        .tree-star {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 30px;
            background: gold;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation: starGlow 2s infinite;
            z-index: 10;
        }

        @keyframes starGlow {
            0%, 100% { box-shadow: 0 0 10px gold; }
            50% { box-shadow: 0 0 25px gold, 0 0 40px gold; }
        }

        .map-snow {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .map-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .shop {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 5px;
        }

        .shop:hover {
            transform: translateY(-5px) scale(1.05);
            z-index: 20;
        }

        .shop-building {
            width: 60px;
            height: 50px;
            border-radius: 8px 8px 0 0;
            position: relative;
        }

        .shop-roof {
            width: 0;
            height: 0;
            border-left: 30px solid transparent;
            border-right: 30px solid transparent;
            border-bottom: 20px solid #8b4513;
            position: absolute;
            top: -20px;
            left: 0;
        }

        .shop-girl {
            width: 30px;
            height: 40px;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: breathe 3s infinite ease-in-out;
        }

        @keyframes breathe {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        .shop-name {
            font-size: 12px;
            margin-top: 5px;
            text-align: center;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            max-width: 80px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .shop.locked {
            filter: grayscale(0.8) brightness(0.5);
            pointer-events: none;
        }

        .shop.active {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.8); }
        }

        .progress-ring {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 80px;
            height: 80px;
            z-index: 100;
        }

        .ring-circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .ring-bg {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .ring-progress {
            stroke: #ffd700;
            stroke-dasharray: 226;
            stroke-dashoffset: 226;
            transition: stroke-dashoffset 1s ease;
        }

        .ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            font-weight: bold;
            color: #ffd700;
        }

        /* ========== å¯¹è¯ç•Œé¢ - é›†æˆæŠ åƒç«‹ç»˜ ========== */
        #dialogue-screen {
            background: #0a1525;
            opacity: 0;
            pointer-events: none;
            z-index: 80;
            display: flex;
        }

        .dialogue-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* å·¦ä¾§ï¼šæŠ åƒç«‹ç»˜åŒºåŸŸ */
        .girl-portrait {
            width: 35%;
            background: rgba(10, 21, 37, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            position: relative;
        }

        .portrait-canvas-container {
            width: 300px;
            height: 400px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            position: relative;
            animation: float 6s ease-in-out infinite;
        }

        .portrait-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        .upload-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #d4af37, #ffd700);
            border: none;
            border-radius: 10px;
            color: #0a1525;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .upload-btn i {
            font-size: 16px;
        }

        #file-input {
            display: none;
        }

        .girl-name {
            margin-top: 30px;
            font-size: 32px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .girl-title {
            font-size: 18px;
            color: #b0bec5;
            margin-top: 5px;
            margin-bottom: 15px;
        }

        /* å³ä¾§ï¼šå¯¹è¯åŒºåŸŸ */
        .dialogue-area {
            width: 65%;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }

        .dialogue-background {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0.3;
            background-size: cover;
            background-position: center;
            z-index: -1;
            filter: blur(5px);
        }

        .dialogue-text {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            min-height: 300px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-bottom: 30px;
            font-size: 20px;
            line-height: 1.6;
            overflow-y: auto;
            font-family: 'Cedarville Cursive', cursive;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dialogue-text:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-5px);
        }

        .dialogue-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .control-button {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .close-dialogue {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .close-dialogue:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .dialogue-indicator {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        /* é»˜è®¤å ä½ç¬¦æ ·å¼ */
        .portrait-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(78, 205, 196, 0.2));
            color: rgba(255, 255, 255, 0.5);
            font-size: 16px;
            text-align: center;
            padding: 20px;
        }

        .portrait-placeholder i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* ========== åœ£è¯æ ‘ç•Œé¢ ========== */
        #tree-screen {
            background: radial-gradient(ellipse at center, #0a1f1f 0%, #050a14 100%);
            opacity: 0;
            pointer-events: none;
            z-index: 70;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .tree-container {
            width: 90%;
            height: 90%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .big-tree {
            width: 500px;
            height: 700px;
            position: relative;
        }

        .big-tree-body {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 200px solid transparent;
            border-right: 200px solid transparent;
            border-bottom: 400px solid #1b5e20;
            z-index: 5;
        }

        .big-tree-body::before {
            content: '';
            position: absolute;
            top: 100px;
            left: -150px;
            width: 0;
            height: 0;
            border-left: 150px solid transparent;
            border-right: 150px solid transparent;
            border-bottom: 300px solid #2e7d32;
        }

        .big-tree-body::after {
            content: '';
            position: absolute;
            top: 200px;
            left: -100px;
            width: 0;
            height: 0;
            border-left: 100px solid transparent;
            border-right: 100px solid transparent;
            border-bottom: 200px solid #388e3c;
        }

        .big-tree-trunk {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 100px;
            background: #5d4037;
            border-radius: 10px;
            z-index: 4;
        }

        .big-tree-star {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            background: gold;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation: starGlow 2s infinite;
            z-index: 10;
        }

        .ornament {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 6;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease;
        }

        .ornament:hover {
            transform: scale(1.2);
        }

        .wish-section {
            position: absolute;
            right: 10%;
            top: 50%;
            transform: translateY(-50%);
            width: 400px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .wish-title {
            font-size: 28px;
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }

        .wish-paper {
            background: url('https://www.transparenttextures.com/patterns/parchment.png');
            background-color: #f5e9d4;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            margin-bottom: 20px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .wish-textarea {
            width: 100%;
            height: 180px;
            background: transparent;
            border: none;
            resize: none;
            font-family: 'Cedarville Cursive', cursive;
            font-size: 18px;
            color: #5d4037;
            line-height: 1.5;
        }

        .wish-textarea:focus {
            outline: none;
        }

        .wish-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .color-picker {
            display: flex;
            gap: 10px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .color-option.selected {
            border-color: white;
            transform: scale(1.2);
        }

        .wish-button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #d4af37, #ffd700);
            border: none;
            border-radius: 10px;
            color: #0a1525;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wish-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .return-to-map {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .return-to-map:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        /* ========== å“åº”å¼è®¾è®¡ ========== */
        @media (max-width: 1200px) {
            .gate { width: 350px; height: 450px; }
            .girl-portrait { width: 40%; }
            .dialogue-area { width: 60%; }
            .portrait-canvas-container { width: 250px; height: 350px; }
        }

        @media (max-width: 768px) {
            .gate { width: 300px; height: 400px; }
            .dialogue-container { flex-direction: column; }
            .girl-portrait { width: 100%; height: 45%; padding: 20px; }
            .dialogue-area { width: 100%; height: 55%; padding: 20px; }
            .portrait-canvas-container { width: 200px; height: 280px; }
            .tree-container { flex-direction: column; }
            .wish-section { position: relative; right: 0; top: 0; transform: none; width: 100%; margin-top: 30px; }
        }
    </style>
</head>
<body>
    <!-- åŠ è½½ç•Œé¢ -->
    <div id="loading-screen" class="screen">
        <div class="snow-container" id="snowfall"></div>
        <div class="gate-container">
            <div class="gate" id="gate">
                <div class="gate-frame"></div>
                <div class="left-door gate-door"></div>
                <div class="right-door gate-door"></div>
                <div class="door-knocker" id="door-knocker">
                    <div class="door-knocker-inner"></div>
                </div>
                <div class="gate-decoration">
                    <div class="holly"></div>
                    <div class="lights">
                        <div class="light" style="animation-delay: 0s;"></div>
                        <div class="light" style="animation-delay: 0.2s;"></div>
                        <div class="light" style="animation-delay: 0.4s;"></div>
                        <div class="light" style="animation-delay: 0.6s;"></div>
                        <div class="light" style="animation-delay: 0.8s;"></div>
                    </div>
                </div>
            </div>
            <div class="gate-text">è½»å©é—¨ç¯ï¼Œå¼€å¯å¥‡å¢ƒ</div>
            <div class="loading-progress">
                <div class="loading-bar" id="loading-bar"></div>
            </div>
        </div>
    </div>

    <!-- åœ°å›¾ç•Œé¢ -->
    <div id="map-screen" class="screen">
        <div class="map-container">
            <div class="map-background"></div>
            <div class="map-snow" id="map-snow"></div>
            <div class="map-content" id="map-content">
                <div class="christmas-tree" id="final-tree">
                    <div class="tree-trunk"></div>
                    <div class="tree-body"></div>
                    <div class="tree-star"></div>
                </div>
                <!-- åº—é“ºå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="progress-ring">
                <svg viewBox="0 0 80 80">
                    <circle class="ring-circle ring-bg" cx="40" cy="40" r="36"></circle>
                    <circle class="ring-circle ring-progress" id="progress-circle" cx="40" cy="40" r="36"></circle>
                </svg>
                <div class="ring-text"><span id="progress-text">0</span>/12</div>
            </div>
            <div class="map-controls">
                <div class="control-btn" id="zoom-in"><i class="fas fa-search-plus"></i></div>
                <div class="control-btn" id="zoom-out"><i class="fas fa-search-minus"></i></div>
                <div class="control-btn" id="reset-view"><i class="fas fa-crosshairs"></i></div>
            </div>
        </div>
    </div>

    <!-- å¯¹è¯ç•Œé¢ -->
    <div id="dialogue-screen" class="screen">
        <div class="close-dialogue" id="close-dialogue"><i class="fas fa-times"></i></div>
        <div class="dialogue-container">
            <div class="girl-portrait">
                <div class="girl-portrait">
    <!-- è¿™é‡Œæ˜¯ä¸€ä¸ª img æ ‡ç­¾ï¼Œç”¨äºåŠ¨æ€æ˜¾ç¤ºå¥³å­©çš„ç«‹ç»˜ -->
    <img id="girl-portrait" src="" alt="Portrait" style="width: 300px; height: 400px;">
</div>
                <!-- æŠ åƒç”»å¸ƒå®¹å™¨ -->
                <div class="portrait-canvas-container">
                    <canvas id="portrait-canvas" class="portrait-canvas" width="300" height="400"></canvas>
                </div>
                
                <div class="girl-name" id="girl-name">Koko</div>
                <div class="girl-title" id="girl-title">å¿ƒè·³å…±é¸£ç”µå°</div>
                
                <!-- ä¸Šä¼ æŒ‰é’® -->
                <input type="file" id="file-input" accept="image/*">
                <button class="upload-btn" onclick="document.getElementById('file-input').click()">
                    <i class="fas fa-upload"></i>ä¸Šä¼ ç«‹ç»˜ï¼ˆè‡ªåŠ¨æŠ åƒï¼‰
                </button>
                
                <div class="dialogue-indicator">ç‚¹å‡»å¯¹è¯ç»§ç»­</div>
            </div>
            <div class="dialogue-area">
                <div class="dialogue-background" id="dialogue-bg"></div>
                <div class="dialogue-text" id="dialogue-text">
                    æ¬¢è¿æ¥åˆ°æˆ‘çš„ä¸–ç•Œï¼æˆ‘æ˜¯Kokoï¼Œä¸€ä¸ªç”¨rapè¡¨è¾¾çœŸå®è‡ªæˆ‘çš„å¥³å­©ã€‚ä»Šå¤©ï¼Œæƒ³å¬å¬é“åˆ˜æµ·èƒŒåçš„æ•…äº‹å—ï¼Ÿ
                </div>
                <div class="dialogue-controls">
                    <button class="control-button" id="prev-dialogue">ä¸Šä¸€å¥</button>
                    <button class="control-button" id="next-dialogue">ä¸‹ä¸€å¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åœ£è¯æ ‘ç•Œé¢ -->
    <div id="tree-screen" class="screen">
        <button class="return-to-map" id="return-to-map">è¿”å›åœ°å›¾</button>
        <div class="tree-container">
            <div class="big-tree" id="big-tree">
                <div class="big-tree-trunk"></div>
                <div class="big-tree-body"></div>
                <div class="big-tree-star"></div>
                <!-- è£…é¥°å“å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="wish-section">
                <h2 class="wish-title">è®¸ä¸‹åœ£è¯å¿ƒæ„¿</h2>
                <div class="wish-paper">
                    <textarea class="wish-textarea" id="wish-textarea" placeholder="å†™ä¸‹ä½ çš„åœ£è¯å¿ƒæ„¿... (æœ€å¤š140å­—)" maxlength="140"></textarea>
                </div>
                <div class="wish-controls">
                    <div class="color-picker">
                        <div class="color-option selected" style="background-color: #ff6b6b;" data-color="#ff6b6b"></div>
                        <div class="color-option" style="background-color: #4ecdc4;" data-color="#4ecdc4"></div>
                        <div class="color-option" style="background-color: #ffd166;" data-color="#ffd166"></div>
                        <div class="color-option" style="background-color: #06d6a0;" data-color="#06d6a0"></div>
                        <div class="color-option" style="background-color: #118ab2;" data-color="#118ab2"></div>
                    </div>
                    <button class="wish-button" id="hang-wish">æŒ‚ä¸Šå¿ƒæ„¿</button>
                </div>
            </div>
        </div>
    </div>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="bg-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-christmas-is-coming-1194.mp3" type="audio/mpeg">
    </audio>
    <audio id="door-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-door-hinge-1181.mp3" type="audio/mpeg">
    </audio>
    <audio id="bell-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3" type="audio/mpeg">
    </audio>

    <script>

// å¥³å­©æ•°æ® - çº¿æ€§å¯¹è¯ç‰ˆæœ¬
const girls = [
    {
        id: 1,
        name: "Koko",
        <img src="assets/portraits/id01.jpg" alt="å¥³å­©ç«‹ç»˜" />
        title: "å¿ƒè·³å…±é¸£ç”µå°",
        color: "#ff6b6b",
        position: {x: 15, y: 30},
        buildingColor: "#d32f2f",
        dialogues: [
            "Yoï¼ç»ˆäºæ¥äº†ä¸ªèƒ½èŠçš„äººï¼å¾ˆå¤šäººåªçœ‹åˆ°æˆ‘çš„rapå’Œå¤–è²Œ...",
            "ä½†é“åˆ˜æµ·ä¸åªæ˜¯é€ å‹ï¼Œå®ƒä»£è¡¨æˆ‘çš„åšæŒã€‚å°±åƒrapï¼Œè¡¨é¢é…·ç‚«ï¼Œå†…æ ¸çœŸå®ã€‚",
            "æ¯å¥æ­Œè¯éƒ½æ˜¯æˆ‘çš„çœŸå®æ„Ÿå—ã€‚å†™rapå°±åƒæŠŠå¿ƒè·³å˜æˆèŠ‚å¥ï¼ŒæŠŠæƒ…ç»ªå˜æˆéŸµè„šã€‚",
            "ä¿æŒè¿™ä¸ªå½¢è±¡ä¼šä¸ä¼šç´¯ï¼Ÿè¯´å®è¯ï¼Œæœ‰æ—¶å€™ä¼š...",
            "ä½†å½“ç²‰ä¸å‘Šè¯‰æˆ‘ï¼Œæˆ‘çš„éŸ³ä¹ç»™äº†ä»–ä»¬å‹‡æ°”ï¼Œä¸€åˆ‡éƒ½å€¼å¾—äº†ã€‚",
            "Yoï¼åœ£è¯è€äººé©¾ç€é›ªæ©‡æ¥ï¼Œç¤¼ç‰©è£…æ»¡ä¸€éº»è¢‹ï¼Œé“åˆ˜æµ·å¥³å­©æœ‰è¯è¯´ï¼šåšçœŸå®çš„è‡ªå·±æœ€è‡ªåœ¨ï¼",
            "è¿™å°±æ˜¯æˆ‘çš„åœ£è¯rapç¥ç¦ï¼ä¿æŒçœŸå®ï¼Œä¿æŒèŠ‚å¥ï¼Œåœ£è¯å¿«ä¹ï¼"
        ],
        icon: "ğŸ¤"
    },
    {
        id: 2,
        name: "æ–‡å¤å¥ˆå°”",
        <img src="assets/portraits/id02.jpg" alt="å¥³å­©ç«‹ç»˜" />
        title: "å…¨æ˜æ˜Ÿå®¢å…",
        color: "#4ecdc4",
        position: {x: 30, y: 15},
        buildingColor: "#00796b",
        dialogues: [
            "æ¬¢è¿ï¼åˆ«è¢«è¿™ä¸€å±‹å­æ”¶è—å“åˆ°ï½æ³°è¿ªç†Šã€å‰ä»–ã€æ£’çƒ...æ¯æ ·éƒ½æ˜¯æˆ‘çš„ä¸åŒé¢ã€‚",
            "å¾ˆå¤šäººé—®æˆ‘æ€ä¹ˆå¹³è¡¡è¿™ä¹ˆå¤šçˆ±å¥½...å…¶å®å®ƒä»¬éƒ½æ˜¯æˆ‘çš„ä¸€éƒ¨åˆ†ï¼Œä¸éœ€è¦å¹³è¡¡ã€‚",
            "æ¯”å¦‚é“å¥‡é˜Ÿçš„æ¯”èµ›ï¼Œ2017å¹´ä¸–ç•Œå¤§èµ›é‚£ä¸€åˆ»ï¼Œå…¨é˜Ÿä¸€å¿ƒçš„æ„Ÿè§‰è®©æˆ‘æ°¸ç”Ÿéš¾å¿˜ã€‚",
            "é‚£ç§æ„Ÿè§‰ï¼Œå°±åƒç°åœ¨å’Œé˜Ÿå‹ä»¬ä¸€èµ·å¥‹æ–—çš„æ¯ä¸€å¤©ã€‚",
            "å¼¹å‰ä»–æ—¶æ˜¯å¦ä¸€ç§çŠ¶æ€ï¼Œè¶³çƒæ˜¯é‡Šæ”¾ï¼Œå‰ä»–æ˜¯æ²‰æ·€ã€‚ä¸€ä¸ªåŠ¨ï¼Œä¸€ä¸ªé™ã€‚",
            "è‡³äºè¿™äº›é»‘èƒ¶å”±ç‰‡...æ•°å­—éŸ³ä¹æ–¹ä¾¿ï¼Œä½†é»‘èƒ¶æœ‰æ¸©åº¦ï¼Œå°±åƒæ³°è¿ªç†Šä¸€æ ·ã€‚",
            "èœ˜è››ä¾ ï¼Ÿä»–å‘Šè¯‰æˆ‘ï¼Œèƒ½åŠ›è¶Šå¤§è´£ä»»è¶Šå¤§ã€‚è¿™ä¹Ÿæ˜¯æˆ‘æƒ³å¯¹æœªæ¥çš„è‡ªå·±è¯´çš„è¯ã€‚",
            "åœ£è¯å¿«ä¹ï¼æ„¿ä½ çš„ç”Ÿæ´»ä¹Ÿåƒæˆ‘çš„æ”¶è—ä¸€æ ·ä¸°å¯Œå¤šå½©ï¼"
        ],
        icon: "âš¾"
    },
    {
        id: 3,
        name: "Woni",
        <img src="assets/portraits/id03.jpg" alt="å¥³å­©ç«‹ç»˜" />
        title: "æ¨±èŠ±èŒ¶å®¤é™å¿ƒå¤„",
        color: "#ffd166",
        position: {x: 70, y: 25},
        buildingColor: "#ff8f00",
        dialogues: [
            "è¯·å...èŒ¶å·²ç»å‡†å¤‡å¥½äº†ã€‚å…ƒé…±æ˜¯æˆ‘çš„æ˜µç§°ï¼Œå› ä¸ºæˆ‘æœ‰æ—¶å€™åƒé¸µé¸Ÿä¸€æ ·èƒ†å°...",
            "ä½†ä»Šå¤©ï¼Œæˆ‘æƒ³è¯•ç€å¤šè¯´ä¸€äº›ã€‚æ˜Ÿæ˜Ÿï¼ˆæˆ‘çš„ç‹—ç‹—ï¼‰æ•™ä¼šæˆ‘ï¼Œé¢å¯¹æ‰æ˜¯æœ€å¥½çš„æ–¹å¼ã€‚",
            "å’Œæ˜Ÿæ˜Ÿåœ¨ä¸€èµ·æ—¶ï¼Œå°±åƒæ¨±èŠ±é£˜è½ä¸€æ ·å®‰å®ã€‚å®ƒä¸ä¼šè¯„åˆ¤æˆ‘ï¼Œåªæ˜¯å®‰é™åœ°é™ªä¼´...",
            "è¿™æ˜¯æˆ‘çè§†çš„æ¸©æŸ”ï¼Œä¹Ÿæ˜¯æˆ‘åœ¨è¿™å–§åš£è¡Œä¸šä¸­çš„é¿é£æ¸¯ã€‚",
            "è¯´åˆ°å¶åƒ...å‚å£çš„åšæŒï¼Œæ¢…è¥¿çš„è°¦é€Šã€‚ä¸åªæ˜¯çƒæŠ€ï¼Œæ›´æ˜¯äººæ ¼é­…åŠ›ã€‚",
            "æˆ‘æƒ³æˆä¸ºé‚£æ ·çš„äººâ€”â€”åœ¨çƒåœºä¸Šé—ªè€€ï¼Œåœ¨ç”Ÿæ´»ä¸­ä¿æŒè°¦å‘ã€‚",
            "æ¨±èŠ±å³ä½¿åœ¨å†¬å¤©ä¹Ÿä¼šæœŸå¾…æ˜¥å¤©çš„ç»½æ”¾...å°±åƒæˆ‘ä»¬ï¼Œå³ä½¿èƒ†å°ä¹Ÿè¦å‹‡æ•¢å‘å‰ã€‚",
            "åœ£è¯å¿«ä¹...æ„¿ä½ çš„å¿ƒä¸­ä¹Ÿæœ‰ä¸€ç‰‡å®é™çš„æ¨±èŠ±æ—ã€‚"
        ],
        icon: "ğŸŒ¸"
    },
    {
        id: 4,
        name: "SOOIN",
        <img src="assets/portraits/id04.jpg" alt="å¥³å­©ç«‹ç»˜" />
        title: "åŠæ¢¦çƒ˜ç„™åŠ",
        color: "#06d6a0",
        position: {x: 85, y: 50},
        buildingColor: "#1b5e20",
        dialogues: [
            "å—¯...ä½ æ¥äº†ã€‚Yomiåˆšåˆšå«é†’æˆ‘...æŠ±æ­‰ï¼Œæˆ‘æ€»æ˜¯å¾ˆå›°ã€‚",
            "ä½†åœ¨æ¢¦é‡Œï¼Œæˆ‘èƒ½çƒ¤å‡ºæœ€ç¾å‘³çš„é¥¼å¹²...è¦å¬å¬æˆ‘çš„æ¢¦å—ï¼Ÿ",
            "æˆ‘æ¢¦åˆ°è¿‡ä¼šæ¸¸æ³³çš„é¥¼å¹²...å¯æƒœæˆ‘æœ¬äººä¸ä¼šæ¸¸æ³³ã€‚æ‰€ä»¥å«Swimkimã€‚",
            "Yomiåœ¨æ¢¦é‡Œæ€»æ˜¯å·åƒåˆšçƒ¤å¥½çš„é¢åŒ…ï¼Œå°±åƒç°å®ä¸­ä¸€æ ·ã€‚",
            "å®ƒæ˜¯æˆ‘çš„é—¹é’Ÿã€å“å°å¸ˆï¼Œä¹Ÿæ˜¯æœ€å¥½çš„å€¾å¬è€…...è™½ç„¶å®ƒåªä¼šæ‘‡å°¾å·´ã€‚",
            "æœ‰æ—¶å€™æˆ‘è§‰å¾—ï¼Œç¡çœ ä¸æ˜¯é€ƒé¿ï¼Œè€Œæ˜¯å¦ä¸€ç§å½¢å¼çš„åˆ›é€ ã€‚",
            "å¦‚æœæœ‰ä¸€å¤©ä¸å›°äº†ï¼Œæˆ‘æœ€æƒ³...å¼€ä¸€å®¶çœŸæ­£çš„çƒ˜ç„™åº—ï¼Œè®©Yomiå½“åº—é•¿ã€‚",
            "ç„¶åå­¦æ¸¸æ³³ï¼Œæˆä¸ºçœŸæ­£çš„Swimkimï¼Œè€Œä¸åªæ˜¯ä¸ªæ¢¦ã€‚",
            "åœ£è¯å¿«ä¹...æ„¿ä½ çš„æ¢¦å¢ƒä¹Ÿå……æ»¡ç”œèœœçš„åˆ›æ„ã€‚"
        ],
        icon: "ğŸª"
    },
    {
        id: 5,
        name: "ææ²…ç¦§",
        <img src="assets/portraits/id05.jpg" alt="å¥³å­©ç«‹ç»˜" />
        title: "è¿åŠ¨ç¾å¦†å¹³è¡¡å®¤",
        color: "#118ab2",
        position: {x: 60, y: 75},
        buildingColor: "#1565c0",
        dialogues: [
            "ä½“è‚²éƒ¨é•¿å’Œç¾å¦†æ§ä¸å†²çªå§ï¼Ÿå°±åƒ...è–„å·§ä¸è¯¥å­˜åœ¨ï¼Œä½†å…¶ä»–å£å‘³éƒ½å¯ä»¥å’Œè°ç›¸å¤„ï¼",
            "ä½œä¸ºä½“è‚²éƒ¨é•¿ï¼Œæˆ‘æ€»å¯¹å¥³å­©ä»¬è¯´ï¼šè¿åŠ¨ä¸æ˜¯ä¸ºäº†å–æ‚¦åˆ«äººï¼Œè€Œæ˜¯ä¸ºäº†å–æ‚¦è‡ªå·±ã€‚",
            "å°±åƒç¾å¦†ï¼Œæ˜¯è‡ªæˆ‘è¡¨è¾¾ï¼Œä¸æ˜¯è¿åˆæ ‡å‡†ã€‚",
            "ç¾å¦†å¯¹æˆ‘æ¥è¯´ï¼Œæ—¢æ˜¯è£…é¥°è®©æˆ‘å¼€å¿ƒï¼Œä¹Ÿæ˜¯ç›”ç”²è®©æˆ‘å‹‡æ•¢ã€‚",
            "ä½“è‚²åœºä¸Šçš„æ±—æ°´å’Œé•œå­å‰çš„å£çº¢ï¼Œéƒ½æ˜¯æˆ‘çš„ä¸€éƒ¨åˆ†ï¼Œä¸éœ€è¦äºŒé€‰ä¸€ã€‚",
            "ç°åœ¨è¯¦ç»†è¯´è¯´è–„å·§ä¸ºä»€ä¹ˆè¯¥è¢«ç¦æ­¢ï¼Ÿè–„è·å’Œå·§å…‹åŠ›å°±åƒæ²¹å’Œæ°´ï¼",
            "å®ƒä»¬åº”è¯¥å„è‡ªç¾ä¸½ï¼Œè€Œä¸æ˜¯å¼ºè¡Œèåˆã€‚è¿™æ˜¯æˆ‘çš„ç¾é£Ÿå“²å­¦ï¼Œä¹Ÿæ˜¯äººç”Ÿå“²å­¦ï¼",
            "è¦åšå°±åšå®Œæ•´çš„è‡ªå·±ï¼Œä¸éœ€è¦ä¸ºäº†è¿åˆè€Œæ··åˆã€‚",
            "åœ£è¯å¿«ä¹ï¼æ„¿ä½ ä¹Ÿæœ‰å‹‡æ°”åšæœ€çœŸå®çš„è‡ªå·±ï¼"
        ],
        icon: "ğŸ’„"
    },
    {
        id: 6,
        name: "æè£ä¹¦",
        <img src="assets/portraits/id06.jpg" alt="å¥³å­©ç«‹ç»˜" />
        title: "æ¶²æ€èŠå£«å’–å•¡é¦†",
        color: "#9d4edd",
        position: {x: 25, y: 70},
        buildingColor: "#7b1fa2",
        dialogues: [
            "å–µï½çœ‹ï¼Œè¿™å—èŠå£«åœ¨æ…¢æ…¢å˜å½¢...å°±åƒæˆ‘çš„äººç”Ÿè§‚ã€‚å¼ºç¡¬å®¹æ˜“æ–­è£‚ï¼ŒæŸ”è½¯æ‰èƒ½é€‚åº”ä¸€åˆ‡ã€‚",
            "æƒ³å°å°é»„èŠå£«é…æ¨±æ¡ƒå—ï¼Ÿè¿™æ˜¯æˆ‘æœ€çˆ±çš„ç»„åˆâ€”â€”æµ“éƒä¸æ¸…æ–°çš„ç¢°æ’ã€‚",
            "åœ¨å·¥ä½œä¸­ä¿æŒ'æŸ”è½¯'ï¼Ÿåƒæ¶²ä½“çŒ«ä¸€æ ·ï¼Œä¿æŒæ ¸å¿ƒä½†é€‚åº”ç¯å¢ƒã€‚",
            "åŸåˆ™æ˜¯éª¨æ¶ï¼Œçµæ´»æ˜¯è‚Œè‚‰ï¼Œç¼ºä¸€ä¸å¯ã€‚",
            "å¹¸è¿æ•°å­—7å¯¹æˆ‘çš„æ„ä¹‰ï¼Ÿ7æ˜¯å®Œç¾æ•°å­—ã€‚ä¸€å‘¨7å¤©ï¼Œå½©è™¹7è‰²...",
            "å®ƒæé†’æˆ‘ï¼Œå®Œæ•´æ¥è‡ªå¤šæ ·æ€§ï¼Œå°±åƒæˆ‘çš„å¤šé‡èº«ä»½ã€‚",
            "èŠå£«çš„åŒ…å®¹ï¼Œè¾£æ¤’çš„çƒ­æƒ…ï¼Œæ¨±æ¡ƒçš„ç”œç¾...ç”Ÿæ´»å°±åƒç¾é£Ÿï¼Œéœ€è¦å¹³è¡¡å„ç§æ»‹å‘³ã€‚",
            "ç²‰è‰²æ˜¯æˆ‘çš„ç”Ÿæ´»ï¼Œé»‘è‰²æ˜¯æˆ‘çš„å·¥ä½œã€‚ä¸¤è€…éƒ½æ˜¯çœŸå®çš„æˆ‘ã€‚",
            "åœ£è¯å¿«ä¹ï¼æ„¿ä½ çš„ç”Ÿæ´»ä¹ŸåƒèŠå£«ä¸€æ ·ï¼ŒæŸ”è½¯è€Œå¯Œæœ‰å¼¹æ€§ã€‚"
        ],
        icon: "ğŸ§€"
    },
    {
        id: 7,
        name: "IROHA",
        <img src="assets/portraits/id07.jpg" alt="å¥³å­©ç«‹ç»˜" />
        title: "è–„å·§æ´¾èˆè¹ˆå®¤",
        color: "#ff9e6d",
        position: {x: 40, y: 60},
        buildingColor: "#e65100",
        dialogues: [
            "æ°å°¼é¾Ÿã€çŒ«å’ªã€é¬¼é­‚...éƒ½æ˜¯æˆ‘ï¼å°±åƒè–„å·§ï¼Œæœ‰äººæ¨æœ‰äººçˆ±ã€‚ä½†èˆè¹ˆè®©ä¸€åˆ‡çŸ›ç›¾å˜å¾—å’Œè°ï½",
            "å¾ˆå¤šäººé—®æˆ‘åœ¨ä¸åŒ'å¡‘'ä¹‹é—´åˆ‡æ¢ä¼šä¸ä¼šç´¯...",
            "ä¸ä¼šï¼Œå› ä¸ºæ¯ä¸ª'æˆ‘'éƒ½æ˜¯çœŸå®çš„ã€‚å°±åƒèˆè¹ˆï¼Œä¸åŒé£æ ¼ä½†åŒä¸€èº«ä½“ã€‚",
            "ææ‹‰ç±³è‹å’Œèˆè¹ˆæœ‰ä»€ä¹ˆå…±é€šç‚¹ï¼Ÿå±‚æ¬¡æ„Ÿï¼",
            "ææ‹‰ç±³è‹æœ‰å’–å•¡ã€å¥¶é…ªã€å¯å¯...èˆè¹ˆæœ‰èŠ‚å¥ã€æƒ…æ„Ÿã€æ•…äº‹ã€‚éƒ½æ˜¯å¤šå±‚æ¬¡çš„äº«å—ã€‚",
            "è‡³äºé‚£ä¸ªè‘—åçš„é²¤é±¼æ‰“æŒº...é¦–å…ˆè¦æœ‰è·Œå€’çš„å‹‡æ°”ï¼Œç„¶åç¬é—´å‘åŠ›ï¼",
            "ç”Ÿæ´»ä¹Ÿæ˜¯è¿™æ ·ï¼šä¸æ€•æ‘”å€’ï¼Œæ‰èƒ½åä¸½èµ·èº«ã€‚",
            "è–„å·§æ´¾ï¼Ÿæ˜¯çš„ï¼Œæˆ‘åšæŒï¼å°±åƒåšæŒåšå¤šé¢çš„è‡ªå·±ã€‚",
            "åœ£è¯å¿«ä¹ï¼æ„¿ä½ çš„ç”Ÿæ´»ä¹Ÿåƒèˆè¹ˆä¸€æ ·ï¼Œå……æ»¡èŠ‚å¥ä¸å’Œè°ã€‚"
        ],
        icon: "ğŸ’ƒ"
    },
    {
        id: 8,
        name: "å¾ä¿Šè¾‰",
        <img src="assets/portraits/id08.jpg" alt="å¥³å­©ç«‹ç»˜" />
        title: "é»‘ç™½é”®æ²‰æ€ç”»å»Š",
        color: "#90be6d",
        position: {x: 75, y: 85},
        buildingColor: "#33691e",
        dialogues: [
            "æ¬¢è¿æ¥åˆ°æˆ‘çš„çŸ›ç›¾ç©ºé—´ã€‚é’¢ç´æ˜¯ç²¾ç¡®çš„ï¼Œç»˜ç”»æ˜¯è‡ªç”±çš„ï¼›è‰è“æ˜¯ç”œçš„ï¼Œæ¦´è²æ˜¯...ä¸å­˜åœ¨çš„ã€‚",
            "é‚£äº›'å¥‡æ€ªç…§ç‰‡'ï¼Œæˆ‘æƒ³æ•æ‰çš„ä¸æ˜¯å¥‡æ€ªï¼Œè€Œæ˜¯ç‹¬ç‰¹çš„è§’åº¦ã€‚",
            "å°±åƒè‰è“ï¼Œå¤§å¤šæ•°äººçœ‹åˆ°çº¢è‰²ï¼Œæˆ‘å¯»æ‰¾é˜´å½±é‡Œçš„é’è‰²ã€‚",
            "é’¢ç´çš„ä¸¥è°¨å¦‚ä½•å½±å“æˆ‘çš„è‡ªç”±åˆ›ä½œï¼Ÿçºªå¾‹å¸¦æ¥çœŸæ­£çš„è‡ªç”±ã€‚",
            "å°±åƒè¿›å‡»çš„å·¨äººï¼Œæ²¡æœ‰åŸå¢™çš„ä¿æŠ¤ï¼Œå°±æ²¡æœ‰æ¢ç´¢ä¸–ç•Œçš„å‹‡æ°”ã€‚",
            "ä¸œäº¬é¦™è•‰é¢åŒ…å’Œè¿›å‡»çš„å·¨äººæœ‰ä»€ä¹ˆå…³è”ï¼Ÿéƒ½æ˜¯æ··åˆä½“ï¼",
            "é¦™è•‰çš„ç”œ and é¢åŒ…çš„å®ï¼Œäººç±»çš„è„†å¼±å’Œå·¨äººçš„åŠ›é‡ã€‚çŸ›ç›¾ä¸­çš„å’Œè°æœ€è¿·äººã€‚",
            "é’¢ç´ã€ç»˜ç”»ã€æ‘„å½±...éƒ½æ˜¯æˆ‘ä¸ä¸–ç•Œå¯¹è¯çš„ä¸åŒè¯­è¨€ã€‚",
            "åœ£è¯å¿«ä¹ï¼æ„¿ä½ ä¹Ÿæ‰¾åˆ°å±äºè‡ªå·±çš„è¡¨è¾¾æ–¹å¼ã€‚"
        ],
        icon: "ğŸ¨"
    },
    {
        id: 9,
        name: "æ—æ«å­FUKO",
        <img src="assets/portraits/id09.jpg" alt="å¥³å­©ç«‹ç»˜" />
        title: "å¤šè¯­è¨€å¹¿æ’­ç«™",
        color: "#f9c74f",
        position: {x: 50, y: 20},
        buildingColor: "#ff9800",
        dialogues: [
            "ë§ˆì´í¬ í…ŒìŠ¤íŠ¸~ï¼ˆéº¦å…‹é£æµ‹è¯•ï¼‰ï¼TOPIK 6çº§ã€ç»•å£ä»¤ã€ä¸»æŒã€KPOP...æˆ‘çš„ä¸–ç•Œç”±å£°éŸ³æ„æˆã€‚",
            "å­¦éŸ©è¯­æœ€éš¾çš„æ˜¯ä»€ä¹ˆï¼Ÿæ•¬è¯­ç³»ç»Ÿï¼ä½†å°±åƒç»•å£ä»¤ï¼Œç»ƒä¹ å¤šäº†å°±é¡ºäº†ã€‚",
            "è¯­è¨€æ˜¯æ¡¥æ¢ï¼Œè¿æ¥ä¸åŒä¸–ç•Œçš„æˆ‘ã€‚",
            "æ¨¡ä»¿ä¸»æŒäººå’ŒçœŸæ­£ä¸»æŒæœ‰ä»€ä¹ˆä¸åŒï¼Ÿæ¨¡ä»¿æ˜¯å¤åˆ¶ï¼Œä¸»æŒæ˜¯åˆ›é€ ã€‚",
            "å°±åƒå¦ˆå¦ˆåšçš„å¡”å¯é¥­ï¼Œåˆ«äººèƒ½åšï¼Œä½†åªæœ‰å¥¹çš„æœ‰'å®¶'çš„å‘³é“ã€‚",
            "æ¯æ¬¡ç»ƒä¹ åˆ°æ·±å¤œï¼Œå¦ˆå¦ˆéƒ½ä¼šåšå¡”å¯é¥­ç­‰æˆ‘ã€‚",
            "é‚£æ˜¯ç–²æƒ«æ—¶æœ€æ¸©æš–çš„å……ç”µç«™ï¼Œä¹Ÿæ˜¯æˆ‘æƒ³å¿µçš„å®¶ä¹¡å‘³ã€‚",
            "å¸•æ°ç‹—ï¼Ÿå®ƒä»£è¡¨çº¯ç²¹çš„å¿«ä¹ï¼Œå°±åƒæˆ‘ç«™åœ¨èˆå°ä¸Šæ—¶çš„å¿ƒæƒ…ã€‚",
            "åœ£è¯å¿«ä¹ï¼æ„¿ä½ çš„ä¸–ç•Œä¹Ÿå……æ»¡ç¾å¦™çš„å£°éŸ³å’Œæ¸©æš–çš„å›å¿†ã€‚"
        ],
        icon: "ğŸ¤"
    },
    {
        id: 10,
        name: "é‡‘æ‹ç‚…Naky",
        <img src="assets/portraits/id10.jpg" alt="å¥³å­©ç«‹ç»˜" />
        title: "Melodyç§˜å¯†åŸºåœ°",
        color: "#f8961e",
        position: {x: 20, y: 45},
        buildingColor: "#e65100",
        dialogues: [
            "ï¼ˆå‹ä½å£°éŸ³ï¼‰è¿™é‡Œæ˜¯æˆ‘çš„ç»å¯¹é¢†åŸŸ...ï¼ˆçªç„¶æŠ±ç€Melodyç©å¶ï¼‰å•Šï¼è¿™åªåˆšåˆ°ï¼",
            "å’³å’³...é‡æ–°å¼€å§‹ã€‚æ¬¢è¿æ¥åˆ°æˆ‘çš„çŸ›ç›¾ä¸–ç•Œã€‚",
            "ä½œä¸ºèˆè¹ˆé˜Ÿé•¿ï¼Œæœ€éš¾çš„æ˜¯å¹³è¡¡ä¸¥å‰å’Œæ¸©æŸ”ã€‚å°ä¸Šè¦å®Œç¾ï¼Œå°ä¸‹è¦ç†è§£ã€‚",
            "å°±åƒMelodyï¼Œå¤–è¡¨å¯çˆ±ï¼Œå†…å¿ƒå¼ºå¤§ã€‚",
            "ä¸ºä»€ä¹ˆè¿™ä¹ˆå–œæ¬¢Melodyï¼Ÿå®ƒä¸ä¼šè¯´è¯ï¼Œä½†æ‡‚å¾—æ‰€æœ‰æƒ…ç»ªã€‚",
            "å½“æˆ‘ä»é…·å¸…çš„é˜Ÿé•¿å˜å›æ™®é€šå¥³å­©æ—¶ï¼Œå®ƒæ˜¯æˆ‘æœ€å¥½çš„å¬ä¼—ã€‚",
            "'BIBIå¦¹'è¿™ä¸ªæ˜µç§°æ˜¯ç²‰ä¸èµ·çš„ï¼å› ä¸ºå°ä¸Š'bibi'ï¼ˆå¼ºåŠ¿ï¼‰ï¼Œå°ä¸‹'å¦¹å¦¹'ï¼ˆå¯çˆ±ï¼‰ã€‚",
            "å¾ˆè´´åˆ‡ï¼Œæˆ‘å…¨ç›˜æ¥å—ï¼è¿™å°±æ˜¯çœŸå®çš„æˆ‘ã€‚",
            "èŠ’æœï¼Ÿæœ€çˆ±ï¼å°±åƒç”Ÿæ´»ï¼Œå¤–è¡¨åšç¡¬ï¼Œå†…åœ¨ç”œç¾å¤šæ±ã€‚",
            "åœ£è¯å¿«ä¹ï¼æ„¿ä½ çš„ç”Ÿæ´»ä¹ŸåƒMelodyä¸€æ ·ï¼Œå……æ»¡æ¸©æŸ”ä¸æƒŠå–œã€‚"
        ],
        icon: "ğŸ­"
    },
    {
        id: 11,
        name: "æçŸ¥ç¦¹Jiwoo",
        <img src="assets/portraits/id11.jpg" alt="å¥³å­©ç«‹ç»˜" />
        title: "å†°èŒ¶å°ç†Šå‰§é™¢",
        color: "#43aa8b",
        position: {x: 65, y: 65},
        buildingColor: "#00695c",
        dialogues: [
            "å¾ˆå¤šäººè¯´æˆ‘'é•¿å¾—èŒå´è¦è€é…·'...ä½†ä¸ºä»€ä¹ˆè¦äºŒé€‰ä¸€å‘¢ï¼Ÿå°±åƒå†°èŒ¶ï¼Œæ—¢æ¸…é†’åˆç”œç¾ã€‚",
            "é«˜ä¸ªå­å¥³ç”Ÿä¼šé¢å¯¹ä»€ä¹ˆç‰¹åˆ«å›°æ‰°ï¼Ÿæ€»è¢«æœŸå¾…è¦'å¼ºåŠ¿'ï¼Œä½†æˆ‘æƒ³è¯´ï¼šé«˜ä¸ªå­ä¹Ÿå¯ä»¥è½¯èŒï¼",
            "å°±åƒMaruï¼ˆæˆ‘çš„å°ç‹—ï¼‰ï¼Œå¤§åªä½†æ¸©æŸ”ã€‚",
            "ä¸ºä»€ä¹ˆè¿™ä¹ˆä¾èµ–å†°èŒ¶ï¼Ÿå†°èŒ¶è®©æˆ‘ä¿æŒæ¸…é†’çš„ç”œèœœã€‚",
            "çƒ˜ç„™æ—¶æç¥ï¼Œçœ‹éŸ³ä¹å‰§æ—¶ä¸æ‰“çŒç¡ï¼Œæ‰“æ¸¸æˆæ—¶ä¿æŒä¸“æ³¨...å®ƒæ˜¯æˆ‘çš„å¤šåŠŸèƒ½ç‡ƒæ–™ã€‚",
            "çƒ˜ç„™å’Œæ‰“å†°çƒï¼Œä¸€æŸ”ä¸€åˆšï¼Œä½ æ€ä¹ˆå¹³è¡¡ï¼Ÿçƒ˜ç„™æ˜¯åˆ›é€ ï¼Œå†°çƒæ˜¯é‡Šæ”¾ã€‚",
            "ä¸€ä¸ªæ¸©æš–å¨æˆ¿ï¼Œä¸€ä¸ªå†°å†·èµ›åœºã€‚ä¸¤è€…éƒ½æ˜¯æˆ‘ä¸ä¸–ç•Œå¯¹è¯çš„æ–¹å¼ã€‚",
            "ç™½è‰²æ˜¯æˆ‘æœ€å–œæ¬¢çš„é¢œè‰²ï¼Œçº¯å‡€å¦‚é›ªï¼ŒåŒ…å®¹ä¸€åˆ‡ã€‚",
            "åœ£è¯å¿«ä¹ï¼æ„¿ä½ ä¹Ÿèƒ½åƒå†°èŒ¶ä¸€æ ·ï¼Œæ‰¾åˆ°ç”Ÿæ´»ä¸­çš„æ¸…é†’ä¸ç”œèœœã€‚"
        ],
        icon: "â˜•"
    },
    {
        id: 12,
        name: "å´”å¿—å®‡",
        <img src="assets/portraits/id12.jpg" alt="å¥³å­©ç«‹ç»˜" />
        title: "ç™½é¼¬çŸ³å¤´ç–—æ„ˆé¦†",
        color: "#a78bfa",
        position: {x: 45, y: 85},
        buildingColor: "#7c3aed",
        dialogues: [
            "æ¬¢è¿æ¥åˆ°æˆ‘çš„ç–—æ„ˆç©ºé—´ï½æ¯”èµ·æˆä¸ºåŠ¨ç‰©ï¼Œæˆ‘æ›´æƒ³æˆä¸ºä¸€å—å®‰é™çš„çŸ³å¤´ã€‚ä½ çŸ¥é“ç™½é¼¬å¡‘å—ï¼Ÿ",
            "æˆ‘çš„æ—¥å¸¸å¾ˆç®€å•ï¼šåŠèº«æµ´ã€è‰è“æ¡ƒå­ã€ç¢³é…¸é¥®æ–™ï¼Œè¿˜æœ‰ã€Šæœºæ™ºçš„åŒ»ç”Ÿç”Ÿæ´»ã€‹ã€‚",
            "ç»¿èŒ¶è‰è“é¦™è‰å·§å…‹åŠ›å†°æ·‡æ·‹æ˜¯æˆ‘çš„æœ€çˆ±ï¼Œé…¸å¥¶å†°æ·‡æ·‹è¦åŠ è‰è“+æ ¼å…°è¯ºæ‹‰éº¦ç‰‡+å¥¶é…ªå—+Lotusé¥¼å¹²ç¢ï¼",
            "è®¨åŒè™«å­ï¼Œå–œæ¬¢èŠ±é¦™çš‚é¦™çš„é¦™æ°´ã€‚ç§æœé‡Œé»‘è‰²æœ€å¤šï¼Œå› ä¸ºåƒçŸ³å¤´çš„æ²‰ç¨³ã€‚",
            "ä½ çŸ¥é“520æ˜¯æˆ‘çˆ±ä½ çš„æ„æ€å—ï¼Ÿå°±åƒã€Šæˆ‘çš„æ˜å¤©ï¼Œä½ çš„æ˜¨å¤©ã€‹é‡Œé‚£ç§è·¨è¶Šæ—¶é—´çš„æ„Ÿæƒ…ã€‚",
            "ç”¨ChatGPTæµ‹å‰ä¸–ï¼Œè¯´æˆ‘ä¸Šè¾ˆå­æ˜¯æŠŠç”Ÿå‘½å¯„æ‰˜åœ¨çºªå¾‹å’Œä¿¡å¿µä¸Šçš„äººâ€”â€”æ•™å¸ˆæˆ–ç¥èŒäººå‘˜ã€‚",
            "è¿‘è§†ä½†ä¸æˆ´çœ¼é•œï¼Œå·¦çœ¼è§†åŠ›æ›´ä½ï¼Œå·¦çœ¼ä¹Ÿæ›´å°ã€‚è„†æ¡ƒæ°´èœœæ¡ƒé‡Œæ›´å–œæ¬¢æ°´èœœæ¡ƒçš„æŸ”è½¯ã€‚",
            "å¬æ­Œä¼šä¸€ç›´å¬åˆ°è…»ï¼ŒUtadaçš„æ­Œå’ŒåŸå‘³Pockyæ˜¯æˆ‘çš„comfort zoneã€‚",
            "åœ£è¯å¿«ä¹ï½æ„¿ä½ èƒ½æ‰¾åˆ°åƒçŸ³å¤´ä¸€æ ·å®‰ç¨³ï¼Œåˆåƒç™½é¼¬ä¸€æ ·çµåŠ¨çš„å¹³è¡¡ã€‚"
        ],
        icon: "ğŸª¨"
    }
];

        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            currentScreen: 'loading',
            completedGirls: [],
            progress: 0,
            currentGirlIndex: 0,
            dialogueStep: 0,
            wishColor: '#ff6b6b',
            // å­˜å‚¨æ¯ä¸ªå¥³å­©çš„ç«‹ç»˜æ•°æ®ï¼ˆbase64æ ¼å¼ï¼‰
            girlPortraits: {}
        };

        // DOMå…ƒç´ 
        const screens = {
            loading: document.getElementById('loading-screen'),
            map: document.getElementById('map-screen'),
            dialogue: document.getElementById('dialogue-screen'),
            tree: document.getElementById('tree-screen')
        };

        // éŸ³é¢‘å…ƒç´ 
        const bgMusic = document.getElementById('bg-music');
        const doorSound = document.getElementById('door-sound');
        const bellSound = document.getElementById('bell-sound');

        // æŠ åƒç”»å¸ƒç›¸å…³
        const portraitCanvas = document.getElementById('portrait-canvas');
        const portraitCtx = portraitCanvas.getContext('2d');
        const fileInput = document.getElementById('file-input');

        // åˆå§‹åŒ–
        function init() {
            createSnowfall();
            setupEventListeners();
            simulateLoading();
        }

        // åˆ›å»ºé›ªèŠ±æ•ˆæœ
        function createSnowfall() {
            const snowContainer = document.getElementById('snowfall');
            const mapSnowContainer = document.getElementById('map-snow');
            
            for(let i = 0; i < 100; i++) {
                createSnowflake(snowContainer);
            }
            
            for(let i = 0; i < 50; i++) {
                createSnowflake(mapSnowContainer);
            }
        }

        function createSnowflake(container) {
            const snowflake = document.createElement('div');
            snowflake.className = 'snowflake';
            
            const size = Math.random() * 5 + 2;
            const startX = Math.random() * 100;
            const duration = Math.random() * 10 + 10;
            const delay = Math.random() * 10;
            
            snowflake.style.width = `${size}px`;
            snowflake.style.height = `${size}px`;
            snowflake.style.left = `${startX}vw`;
            snowflake.style.opacity = Math.random() * 0.5 + 0.3;
            snowflake.style.animationDuration = `${duration}s`;
            snowflake.style.animationDelay = `${delay}s`;
            
            container.appendChild(snowflake);
        }

        // æ¨¡æ‹ŸåŠ è½½è¿‡ç¨‹
        function simulateLoading() {
            const loadingBar = document.getElementById('loading-bar');
            let progress = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 10 + 5;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    loadingBar.style.width = '100%';
                    setTimeout(() => {
                        playWelcomeAudio();
                    }, 500);
                } else {
                    loadingBar.style.width = `${progress}%`;
                }
            }, 200);
        }

        // æ’­æ”¾æ¬¢è¿éŸ³é¢‘
        function playWelcomeAudio() {
            bellSound.play();
            
            // æ˜¾ç¤ºç‚¹å‡»æç¤º
            const gateText = document.querySelector('.gate-text');
            gateText.textContent = "ç‚¹å‡»é—¨ç¯è¿›å…¥æ¸¸å›­ä¼š";
            gateText.style.animation = "textGlow 1.5s infinite";
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // é—¨ç¯ç‚¹å‡»
            document.getElementById('door-knocker').addEventListener('click', openGate);
            
            // åœ°å›¾æ§åˆ¶
            document.getElementById('zoom-in').addEventListener('click', () => zoomMap(1.2));
            document.getElementById('zoom-out').addEventListener('click', () => zoomMap(0.8));
            document.getElementById('reset-view').addEventListener('click', resetMapView);
            
            // å¯¹è¯æ§åˆ¶
            document.getElementById('close-dialogue').addEventListener('click', closeDialogue);
            document.getElementById('prev-dialogue').addEventListener('click', prevDialogue);
            document.getElementById('next-dialogue').addEventListener('click', nextDialogue);
            
            // å¯¹è¯æ–‡æœ¬ç‚¹å‡»
            document.getElementById('dialogue-text').addEventListener('click', nextDialogue);
            
            // æ–‡ä»¶ä¸Šä¼ 
            fileInput.addEventListener('change', handleImageUpload);
            
            // å¿ƒæ„¿æ§åˆ¶
            document.getElementById('hang-wish').addEventListener('click', hangWish);
            document.getElementById('return-to-map').addEventListener('click', returnToMap);
            
            // é¢œè‰²é€‰æ‹©
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.wishColor = this.getAttribute('data-color');
                });
            });
            
            // åœ£è¯æ ‘ç‚¹å‡»
            document.getElementById('final-tree').addEventListener('click', () => {
                if (gameState.completedGirls.length === girls.length) {
                    switchScreen('tree');
                }
            });
        }

        // æ‰“å¼€å¤§é—¨
        function openGate() {
            const leftDoor = document.querySelector('.left-door');
            const rightDoor = document.querySelector('.right-door');
            const gate = document.getElementById('gate');
            
            // æ’­æ”¾éŸ³æ•ˆ
            doorSound.play();
            bgMusic.volume = 0.3;
            bgMusic.play();
            
            // åŠ¨ç”»æ•ˆæœ
            leftDoor.style.transform = 'perspective(1000px) rotateY(-100deg)';
            rightDoor.style.transform = 'perspective(1000px) rotateY(100deg)';
            gate.style.cursor = 'default';
            
            // è¿‡æ¸¡åˆ°åœ°å›¾ç•Œé¢
            setTimeout(() => {
                switchScreen('map');
                createShops();
            }, 1500);
        }

        // åˆ‡æ¢å±å¹•
        function switchScreen(screenName) {
            // éšè—æ‰€æœ‰å±å¹•
            Object.values(screens).forEach(screen => {
                screen.style.opacity = '0';
                screen.style.pointerEvents = 'none';
            });
            
            // æ˜¾ç¤ºç›®æ ‡å±å¹•
            screens[screenName].style.opacity = '1';
            screens[screenName].style.pointerEvents = 'auto';
            gameState.currentScreen = screenName;
            
            // ç‰¹æ®Šå¤„ç†
            if (screenName === 'map') {
                updateProgress();
            } else if (screenName === 'tree') {
                createOrnaments();
            }
        }

        // åˆ›å»ºåº—é“º
        function createShops() {
            const mapContent = document.getElementById('map-content');
            
            // æ¸…ç©ºç°æœ‰åº—é“º
            const existingShops = document.querySelectorAll('.shop');
            existingShops.forEach(shop => shop.remove());
            
            // åˆ›å»ºæ–°åº—é“º
            girls.forEach(girl => {
                const shop = document.createElement('div');
                shop.className = `shop ${gameState.completedGirls.includes(girl.id) ? 'completed' : 'active'}`;
                shop.id = `shop-${girl.id}`;
                shop.style.left = `${girl.position.x}%`;
                shop.style.top = `${girl.position.y}%`;
                shop.style.backgroundColor = girl.buildingColor;
                
                shop.innerHTML = `
                    <div class="shop-building">
                        <div class="shop-roof"></div>
                        <div class="shop-girl" style="background-color: ${girl.color}; border-radius: 50% 50% 0 0;"></div>
                    </div>
                    <div class="shop-name">${girl.name}</div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                shop.addEventListener('click', () => openDialogue(girl));
                
                // æ·»åŠ æ‚¬åœäº‹ä»¶
                shop.addEventListener('mouseenter', () => {
                    if (!gameState.completedGirls.includes(girl.id)) {
                        shop.style.boxShadow = `0 0 20px ${girl.color}`;
                    }
                });
                
                shop.addEventListener('mouseleave', () => {
                    if (!gameState.completedGirls.includes(girl.id)) {
                        shop.style.boxShadow = 'none';
                    }
                });
                
                mapContent.appendChild(shop);
            });
        }

     // æ‰“å¼€å¯¹è¯
function openDialogue(girl) {
    gameState.currentGirlIndex = girl.id - 1;  // æ›´æ–°å½“å‰å¥³å­©ç´¢å¼•
    gameState.dialogueStep = 0;  // é‡ç½®å¯¹è¯æ­¥éª¤

    // æ›´æ–°UI
    document.getElementById('girl-name').textContent = girl.name;
    document.getElementById('girl-title').textContent = girl.title;
    document.getElementById('dialogue-bg').style.backgroundColor = girl.color;
    document.getElementById('dialogue-text').textContent = girl.dialogues[0];

    // æ˜¾ç¤ºå¥³å­©çš„ç«‹ç»˜å›¾ç‰‡
    const imgElement = document.getElementById('girl-portrait');  // è·å– img æ ‡ç­¾
    imgElement.src = girl.portrait;  // æ›´æ–° src ä¸ºå¥³å­©çš„å›¾ç‰‡è·¯å¾„

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    updateDialogueButtons();

    // åˆ‡æ¢å±å¹•
    switchScreen('dialogue');
}

        function loadGirlPortrait(girl) {
    const girlId = girl.id;

    // æ¸…ç©ºç”»å¸ƒ
    portraitCtx.clearRect(0, 0, portraitCanvas.width, portraitCanvas.height);

    // ä¼˜å…ˆçº§ 1ï¼šç”¨æˆ·ä¸Šä¼ è¿‡çš„ç«‹ç»˜
    if (gameState.girlPortraits[girlId]) {
        const img = new Image();
        img.onload = () => drawImageToCanvas(img);
        img.src = gameState.girlPortraits[girlId];
        return;
    }

    // ä¼˜å…ˆçº§ 2ï¼šæœ¬åœ° portraits/idXX.jpg
    if (girl.portrait) {
        const img = new Image();
        img.onload = () => drawImageToCanvas(img);
        img.onerror = () => {
            console.warn("ç«‹ç»˜åŠ è½½å¤±è´¥ï¼š", girl.portrait);
            drawPlaceholderPortrait(girl);
        };
        img.src = girl.portrait;
        return;
    }

    // å…œåº•ï¼šå ä½ç¬¦
    drawPlaceholderPortrait(girl);
}
        function drawImageToCanvas(img) {
    const cw = portraitCanvas.width;
    const ch = portraitCanvas.height;

    // ç­‰æ¯”å¡«å……ï¼ˆç±»ä¼¼ background-size: coverï¼‰
    const scale = Math.max(cw / img.width, ch / img.height);
    const dw = img.width * scale;
    const dh = img.height * scale;
    const dx = (cw - dw) / 2;
    const dy = (ch - dh) / 2;

    portraitCtx.clearRect(0, 0, cw, ch);
    portraitCtx.drawImage(img, dx, dy, dw, dh);
}
        // æ˜¾ç¤ºä¸Šä¼ æˆåŠŸæç¤º
        function showUploadSuccess() {
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: absolute;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(76, 175, 80, 0.9);
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                font-weight: bold;
                z-index: 1000;
                animation: fadeInOut 2s ease;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0%, 100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    10%, 90% { opacity: 1; transform: translateX(-50%) translateY(0); }
                }
            `;
            document.head.appendChild(style);
            
            successMsg.textContent = 'âœ“ ç«‹ç»˜ä¸Šä¼ æˆåŠŸï¼';
            document.querySelector('.girl-portrait').appendChild(successMsg);
            
            // 2ç§’åç§»é™¤æç¤º
            setTimeout(() => {
                successMsg.remove();
                style.remove();
            }, 2000);
        }

        // æ›´æ–°å¯¹è¯æŒ‰é’®çŠ¶æ€
        function updateDialogueButtons() {
            const girl = girls[gameState.currentGirlIndex];
            const prevBtn = document.getElementById('prev-dialogue');
            const nextBtn = document.getElementById('next-dialogue');
            
            // ä¸Šä¸€å¥æŒ‰é’®
            if (gameState.dialogueStep === 0) {
                prevBtn.style.opacity = '0.5';
                prevBtn.style.pointerEvents = 'none';
            } else {
                prevBtn.style.opacity = '1';
                prevBtn.style.pointerEvents = 'auto';
            }
            
            // ä¸‹ä¸€å¥æŒ‰é’®
            if (gameState.dialogueStep === girl.dialogues.length - 1) {
                nextBtn.textContent = 'å®Œæˆå¯¹è¯';
            } else {
                nextBtn.textContent = 'ä¸‹ä¸€å¥';
            }
        }

        // å…³é—­å¯¹è¯
        function closeDialogue() {
            switchScreen('map');
        }

        // ä¸Šä¸€ä¸ªå¯¹è¯
        function prevDialogue() {
            if (gameState.dialogueStep > 0) {
                gameState.dialogueStep--;
                const girl = girls[gameState.currentGirlIndex];
                document.getElementById('dialogue-text').textContent = girl.dialogues[gameState.dialogueStep];
                updateDialogueButtons();
            }
        }

        // ä¸‹ä¸€ä¸ªå¯¹è¯
        function nextDialogue() {
            const girl = girls[gameState.currentGirlIndex];
            
            if (gameState.dialogueStep < girl.dialogues.length - 1) {
                // è¿˜æœ‰æ›´å¤šå¯¹è¯
                gameState.dialogueStep++;
                document.getElementById('dialogue-text').textContent = girl.dialogues[gameState.dialogueStep];
                updateDialogueButtons();
            } else {
                // å¯¹è¯ç»“æŸ
                completeDialogue();
            }
        }

        // å®Œæˆå¯¹è¯
        function completeDialogue() {
            const girlId = gameState.currentGirlIndex + 1;
            
            if (!gameState.completedGirls.includes(girlId)) {
                gameState.completedGirls.push(girlId);
                gameState.progress = Math.round((gameState.completedGirls.length / girls.length) * 100);
                
                // æ›´æ–°è¿›åº¦
                updateProgress();
                
                // æ˜¾ç¤ºå®Œæˆæç¤º
                setTimeout(() => {
                    alert(`âœ“ å·²å®Œæˆä¸${girls[gameState.currentGirlIndex].name}çš„å¯¹è¯ï¼\nå·²æ”¶é›† ${gameState.completedGirls.length}/12 ä¸ªå¿ƒçµç¢ç‰‡`);
                }, 300);
            }
            
            // è¿”å›åœ°å›¾
            switchScreen('map');
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            const progress = gameState.completedGirls.length;
            const progressText = document.getElementById('progress-text');
            const progressCircle = document.getElementById('progress-circle');
            
            progressText.textContent = progress;
            
            // è®¡ç®—è¿›åº¦åœ†ç¯
            const circumference = 2 * Math.PI * 36;
            const offset = circumference - (progress / girls.length) * circumference;
            progressCircle.style.strokeDashoffset = offset;
            
            // æ›´æ–°åº—é“ºçŠ¶æ€
            girls.forEach(girl => {
                const shop = document.getElementById(`shop-${girl.id}`);
                if (shop) {
                    if (gameState.completedGirls.includes(girl.id)) {
                        shop.classList.remove('active');
                        shop.classList.add('completed');
                        shop.style.boxShadow = `0 0 15px ${girl.color}`;
                    } else {
                        shop.classList.add('active');
                        shop.classList.remove('completed');
                    }
                }
            });
            
            // æ›´æ–°åœ£è¯æ ‘çŠ¶æ€
            const finalTree = document.getElementById('final-tree');
            if (gameState.completedGirls.length === girls.length) {
                finalTree.style.cursor = 'pointer';
                finalTree.style.animation = 'pulse-glow 2s infinite';
            }
        }

        // åˆ›å»ºè£…é¥°å“
        function createOrnaments() {
            const tree = document.getElementById('big-tree');
            
            // æ¸…ç©ºç°æœ‰è£…é¥°å“
            const existingOrnaments = document.querySelectorAll('.ornament');
            existingOrnaments.forEach(ornament => ornament.remove());
            
            // æ·»åŠ è£…é¥°å“
            girls.forEach(girl => {
                if (gameState.completedGirls.includes(girl.id)) {
                    const angle = Math.random() * 2 * Math.PI;
                    const distance = Math.random() * 180 + 100;
                    
                    const x = 250 + Math.cos(angle) * distance;
                    const y = 400 - Math.sin(angle) * distance;
                    
                    const ornament = document.createElement('div');
                    ornament.className = 'ornament';
                    ornament.style.left = `${x}px`;
                    ornament.style.top = `${y}px`;
                    ornament.style.backgroundColor = girl.color;
                    ornament.title = girl.name;
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ˜¾ç¤ºä¿¡æ¯
                    ornament.addEventListener('click', () => {
                        alert(`${girl.name}çš„ç¥ç¦ï¼š\n${girl.dialogues[girl.dialogues.length - 1]}`);
                    });
                    
                    tree.appendChild(ornament);
                }
            });
        }

        // æŒ‚ä¸Šå¿ƒæ„¿
        function hangWish() {
            const wishText = document.getElementById('wish-textarea').value.trim();
            
            if (!wishText) {
                alert('è¯·å†™ä¸‹ä½ çš„åœ£è¯å¿ƒæ„¿ï¼');
                return;
            }
            
            if (wishText.length > 140) {
                alert('å¿ƒæ„¿ä¸èƒ½è¶…è¿‡140å­—ï¼');
                return;
            }
            
            // åˆ›å»ºå¿ƒæ„¿è£…é¥°å“
            const tree = document.getElementById('big-tree');
            const x = 250 + (Math.random() - 0.5) * 100;
            const y = 200 + Math.random() * 200;
            
            const wishOrnament = document.createElement('div');
            wishOrnament.className = 'ornament';
            wishOrnament.style.left = `${x}px`;
            wishOrnament.style.top = `${y}px`;
            wishOrnament.style.backgroundColor = gameState.wishColor;
            wishOrnament.style.width = '40px';
            wishOrnament.style.height = '40px';
            wishOrnament.style.borderRadius = '5px';
            wishOrnament.style.display = 'flex';
            wishOrnament.style.justifyContent = 'center';
            wishOrnament.style.alignItems = 'center';
            wishOrnament.innerHTML = '<i class="fas fa-star" style="color: white; font-size: 16px;"></i>';
            wishOrnament.title = wishText.length > 30 ? wishText.substring(0, 30) + '...' : wishText;
            
            // æ·»åŠ åˆ°æ ‘ä¸Š
            tree.appendChild(wishOrnament);
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert('âœ¨ å¿ƒæ„¿å·²æŒ‚ä¸Šåœ£è¯æ ‘ï¼\næ„¿ä½ çš„æ„¿æœ›æˆçœŸï¼ğŸ„');
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('wish-textarea').value = '';
        }

        // è¿”å›åœ°å›¾
        function returnToMap() {
            switchScreen('map');
        }

        // åœ°å›¾ç¼©æ”¾
        function zoomMap(factor) {
            const mapContent = document.getElementById('map-content');
            const currentScale = parseFloat(getComputedStyle(mapContent).transform.split(',')[3]) || 1;
            const newScale = Math.max(0.5, Math.min(2, currentScale * factor));
            
            mapContent.style.transform = `scale(${newScale})`;
        }

        // é‡ç½®åœ°å›¾è§†å›¾
        function resetMapView() {
            const mapContent = document.getElementById('map-content');
            mapContent.style.transform = 'scale(1)';
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
